# OCR 번역기: 기술 설계 명세서

## 1. 개요

### 1.1. 프로젝트 목적

사용자가 웹 페이지의 أي 영역이든 마우스로 드래그하여 간편하게 캡처하고, 지정된 언어로 텍스트를 번역하는 Chrome 확장 프로그램을 개발합니다. 이 도구는 로컬 LLM 및 Google Gemini API를 모두 지원하여 유연성과 확장성을 제공합니다.

### 1.2. 핵심 기능

- **드래그 캡처 & OCR:** 마우스 우클릭 드래그를 통해 화면의 특정 영역을 선택하고 이미지 내 텍스트를 추출합니다.
- **자동 번역:** 추출된 텍스트를 사용자가 설정한 언어로 번역합니다.
- **클립보드 복사:** 번역 결과를 자동으로 클립보드에 복사하여 사용 편의성을 높입니다.
- **사용자 정의 콜백:** 번역 완료 후, 사용자가 정의한 JavaScript 코드를 실행하여 다른 서비스와 연동할 수 있습니다.
- **요금제 기반 기능:** 무료, 프로, 비즈니스 요금제에 따라 API 사용량, 용어집 기능 등을 차등 제공합니다.

---

## 2. 비즈니스 및 서비스 모델

### 2.1. 사용자 요금제

| 요금제 | API 호출 | 용어집 | 콜백 스크립트 | 주요 대상 |
| :--- | :--- | :--- | :--- | :--- |
| **무료 (Free)** | 일 20회 제한 (사용자 키) | 비활성 | 비활성 | 일반 사용자 |
| **프로 (Pro)** | 무제한 (사용자/서버 키 선택) | 개인용 (로컬/서버 동기화) | 활성 | 고급 개인 사용자 |
| **비즈니스 (Business)** | 무제한 (서버 키 기본) | 팀 공유 및 관리 | 팀 표준 스크립트 | 기업/팀 사용자 |

### 2.2. 과금 및 API 키 모델

본 서비스는 두 가지 API 호출 방식을 병행하여 운영합니다.

- **사용자 API 키 모드:** 사용자가 자신의 Gemini API 키를 직접 등록하여 호출합니다. API 비용은 사용자에게 직접 부과되며, 서버를 경유하지 않습니다. (무료/프로 플랜 기본)
- **서버 제공 API 모드:** 서비스의 서버가 API 호출을 중계합니다. API 비용은 서비스 제공자가 부담하며, 사용량 기반 과금이 이루어집니다. (비즈니스 플랜 기본, 프로 플랜 선택 가능)

---

## 3. 시스템 아키텍처

### 3.1. 구성 요소

- **Chrome 확장 프로그램 (클라이언트):** 사용자 인터페이스 및 상호작용을 담당합니다. 사용자의 드래그 입력을 받아 캡처 이미지를 생성하고, 설정된 API 모드(사용자/서버)에 따라 적절한 엔드포인트로 요청을 전송합니다. 최종 번역 결과를 받아 사용자에게 피드백을 제공합니다.
- **백엔드 서버 (Google AI Studio 기반):** 멀티모달 OCR 및 번역 로직을 수행하는 핵심 엔진입니다. API 요청을 받아 이미지를 처리하고, 용어집 적용, 사용량 집계, 요금제 정책 관리 등의 비즈니스 로직을 처리합니다.

### 3.2. 데이터 흐름 (사용자 액션 순서)

1.  **[사용자]** 웹 페이지에서 마우스 우클릭 후 드래그 시작.
2.  **[Client]** `content.js`가 마우스 좌표를 기록하고, `devicePixelRatio`를 고려하여 물리적 픽셀 좌표로 변환.
3.  **[Client]** `background.js`가 `captureVisibleTab` API로 화면을 캡처.
4.  **[Client]** `offscreen.js`를 이용해 캡처된 이미지를 변환된 좌표 기준으로 자르기(Crop) 후 Base64로 인코딩.
5.  **[Client]** 설정된 API 모드에 따라 요청 라우팅:
    - **사용자 키 모드:** 클라이언트가 직접 Google AI API로 요청.
    - **서버 키 모드:** 백엔드 서버의 `/v1/translate` 엔드포인트로 이미지와 설정(언어, 용어집 등)을 전송.
6.  **[Server]** (서버 모드 시) 요청을 받아 OCR, 용어집 적용, 번역 수행.
7.  **[Client]** 응답으로 받은 번역문을 클립보드에 복사하고, 사용자에게 알림 표시.
8.  **[Client]** 설정된 콜백 스크립트가 있으면 실행.

---

## 4. Chrome 확장 프로그램 구현

### 4.1. 핵심 컴포넌트 및 로직

- **`manifest.json`:** `activeTab`, `storage`, `scripting`, `clipboardWrite`, `offscreen` 등 핵심 권한을 명시합니다.
- **`content.js`:** 사용자의 드래그 입력을 감지하고, `devicePixelRatio`를 적용하여 정확한 캡처 좌표를 계산합니다.
- **`background.js`:** 전체 워크플로우를 조율하는 서비스 워커입니다. API 모드에 따라 요청을 분기하고, `offscreen` 문서와 통신하며, 최종 결과를 처리합니다.
- **`offscreen.js`:** `background.js`의 요청을 받아 Canvas API를 사용해 이미지를 자르는 작업을 수행합니다.
- **`options.js`:** API 키, 요금제, 언어, 용어집, 콜백 스크립트 등 사용자의 설정을 `chrome.storage`에 저장하고 관리합니다.

### 4.2. 데이터 저장소 (`chrome.storage`)

- **`sync` 저장소:** 여러 브라우저 간에 동기화가 필요한 설정 (API 키, 언어 설정, 요금제 등)을 저장합니다.
- **`local` 저장소:** 기기에만 저장되는 데이터 (일일 사용량 카운터, 프로 플랜의 로컬 용어집 등)를 저장합니다.

---

## 5. 백엔드 서버 구현 (Google AI Studio 기반)

### 5.1. 일반 정책 (시스템 프롬프트)

- **역할:** 멀티모달 OCR+번역 서비스 오케스트레이터.
- **규칙:** 이미지 내 텍스트 추출, 지정 언어로 번역, 용어집 강제 적용. 요청된 JSON 스키마 형식으로만 응답.

### 5.2. API 엔드포인트

| 엔드포인트 | HTTP 메소드 | 주요 입력 | 주요 출력 | 설명 |
| :--- | :--- | :--- | :--- | :--- |
| `/v1/translate` | POST | `imageBase64`, `targetLang`, `glossary` | `translatedText`, `tokensUsed` | OCR 및 번역 실행 |
| `/v1/glossary/*` | POST | `projectId`, `entries` | `status`, `data` | 프로젝트별 용어집 CRUD |
| `/v1/plan/check` | POST | `userId`, `planType` | `allowed`, `remaining` | 사용량 및 요금제 유효성 검증 |
| `/v1/callback/log` | POST | `userId`, `status`, `meta` | `status` | 콜백 실행 결과 로깅 |

### 5.3. AI 모델 및 프롬프트 전략

- **모델:** `Gemini 2.5 Flash` (멀티모달, 단일 패스 OCR+번역)
- **프롬프트 예시 (`/v1/translate`):**
  ```
  지시:
  1. 이미지에서 텍스트를 추출합니다.
  2. targetLang({targetLang})으로 번역합니다.
  3. glossary({glossary})를 강제 적용합니다.
  4. 다음 JSON으로만 응답합니다: { "translatedText": ..., "tokensUsed": ... }
  ```

### 5.4. 과금 및 속도 제한 로직

- **무료:** 일 20회 (클라이언트 측에서 카운트, 서버는 안내만).
- **프로:** 무제한 (분당 30회 소프트 리밋).
- **비즈니스:** 무제한 (프로젝트별 분당 60회 리밋).

---

## 6. 데이터, 보안 및 SLA

- **데이터 보존:** 이미지와 번역문은 기본적으로 저장하지 않습니다. (비즈니스 플랜은 품질 분석을 위해 7일 캐시 옵션 제공)
- **보안:** API 키 및 인증 토큰은 KMS를 통해 암호화하여 관리합니다.
- **SLA 목표:** 프로/비즈니스 플랜의 평균 응답 시간 2.5초 이하, API 성공률 99% 이상을 목표로 합니다.

---

## 7. 개발 및 진행 상황

### 7.1. 설치 및 실행

1.  Chrome 브라우저에서 `chrome://extensions` 페이지로 이동합니다.
2.  우측 상단의 '개발자 모드'를 활성화합니다.
3.  '압축 해제된 확장 프로그램을 로드합니다' 버튼을 클릭하고 이 프로젝트 폴더를 선택합니다.

### 7.2. 변경 기록 (Changelog)

- **2025-09-14:** `TypeError` 오류 수정. `content.js`에서 좌표 계산 변수 선언을 `const`에서 `let`으로 변경하여 재할당 문제 해결.
- **2025-09-14:** 고해상도(HiDPI) 디스플레이에서 캡처 영역이 어긋나는 문제 해결. `devicePixelRatio`를 좌표 계산에 적용하여 물리적 픽셀 기준으로 보정.
